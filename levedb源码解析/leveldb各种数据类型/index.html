<!DOCTYPE html>
<html>
  <head>
    <title>DocDock Documentation</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="revised" content="2019-04-21T19:20:25 CST">
<title>LevelDB数据类型 :: DocDock Documentation</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/theme-flex/style.css" rel="stylesheet">

	<link href="/theme-flex/variant-gray.css" rel="stylesheet">

<link rel="stylesheet" href="/css/bootstrap.min.css">
<script src="/js/jquery-2.x.min.js"></script>
<script type="text/javascript">
      var baseurl = "https:\/\/cgkiliu.github.io\/";
</script>
<meta name="description" content="LevelDB数据类型">



    
  </head>
  <body data-url="/levedb%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/leveldb%E5%90%84%E7%A7%8D%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/">
    
      <header>
  <div class="logo">
    
	
  
    <a class="baselink" href="https://cgkiliu.github.io/">DocDock Documentation</a>
  


  </div>
  <div class="burger"><a href="javascript:void(0);" style="font-size:15px;">&#9776;</a></div>
    <nav class="shortcuts">
            <li class="" role="">
                <a href="https://github.com/vjeantet/hugo-theme-docdock" target="_blank" rel="noopener">
                  <i class='fa fa-github'></i> <label>Github repo</label>
                </a>
            </li>
            <li class="" role="">
                <a href="https://github.com/vjeantet/hugo-theme-docdock/archive/master.zip" target="_blank" rel="noopener">
                  <i class='fa fa-cloud-download'></i> <label>Download</label>
                </a>
            </li>
            <li class="" role="">
                <a href="https://gohugo.io/" target="_blank" rel="noopener">
                  <i class='fa fa-bookmark'></i> <label>Hugo Documentation</label>
                </a>
            </li>
            <li class="" role="">
                <a href="/credits" target="_blank" rel="noopener">
                  <i class='fa fa-bullhorn'></i> <label>Credits</label>
                </a>
            </li>
    </nav>
</header>
<article>
  <aside>
    <ul class="menu">
          <li data-nav-id="/" class="dd-item">
          <a href="/">
            <i class="fa fa-fw fa-home"></i>
          </a>
          </li>
    <li data-nav-id="/leetcode%E9%A2%98%E8%A7%A3/" class="dd-item alwaysopen haschildren
        ">
      <div>
      <a href="/leetcode%E9%A2%98%E8%A7%A3/">LeetCode题解</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/leetcode%E9%A2%98%E8%A7%A3/reveal_cards_in_increasing_order/" class="dd-item">
        <div>
          <a href="/leetcode%E9%A2%98%E8%A7%A3/reveal_cards_in_increasing_order/">
            Reveal Cards In Increasing Order
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/leetcode%E9%A2%98%E8%A7%A3/test/" class="dd-item">
        <div>
          <a href="/leetcode%E9%A2%98%E8%A7%A3/test/">
            Reveal Cards In Increasing Order
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/levedb%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" class="dd-item parent alwaysopen haschildren
        ">
      <div>
      <a href="/levedb%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">LevelDB源码解析</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/levedb%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/leveldb%E5%90%84%E7%A7%8D%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" class="dd-item active">
        <div>
          <a href="/levedb%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/leveldb%E5%90%84%E7%A7%8D%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/">
            LevelDB数据类型
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/levedb%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/varint%E4%B8%8E%E7%BC%96%E7%A0%81/" class="dd-item">
        <div>
          <a href="/levedb%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/varint%E4%B8%8E%E7%BC%96%E7%A0%81/">
            VarInt与编码
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>




    </ul>
    <section>
    </section>
  </aside>
  <section class="page">
    
    <div class="nav-select">
      <center>Navigation : 
        <select onchange="javascript:location.href = this.value;">
          
    <option value="/leetcode%E9%A2%98%E8%A7%A3/" >
   LeetCode题解</option> 
      <option value="/leetcode%E9%A2%98%E8%A7%A3/reveal_cards_in_increasing_order/" >- Reveal Cards In Increasing Order</option>
      <option value="/leetcode%E9%A2%98%E8%A7%A3/test/" >- Reveal Cards In Increasing Order</option>
  
    <option value="/levedb%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" >
   LevelDB源码解析</option> 
      <option value="/levedb%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/leveldb%E5%90%84%E7%A7%8D%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/"  selected>- LevelDB数据类型</option>
      <option value="/levedb%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/varint%E4%B8%8E%E7%BC%96%E7%A0%81/" >- VarInt与编码</option>
  



        </select>
      </center>
    </div>
      <div>
        <div class="searchbox">
          <input data-search-input id="search-by" type="text" placeholder="Search...">
        </div>
        <script type="text/javascript" src="/js/lunr.min.js"></script>
        <script type="text/javascript" src="/js/auto-complete.js"></script>
        <link href="/css/auto-complete.css" rel="stylesheet">
        <script type="text/javascript">
          
              var baseurl = "https:\/\/cgkiliu.github.io\/";
          
        </script>
        <script type="text/javascript" src="/js/search.js"></script>
      </div>
    

    <h1>LevelDB数据类型</h1>
    
    
    
    

<ul>
<li><a href="#sequencenumber"><strong>SequenceNumber</strong></a>

<ul>
<li><a href="#sequence">sequence</a></li>
<li><a href="#valuetype">ValueType</a></li>
</ul></li>

<li><p><a href="#%E9%94%AE"><strong>键</strong></a></p>

<ul>
<li><a href="#userkey"><strong>user_key</strong></a></li>
<li><a href="#internalkey">InternalKey</a></li>
<li><a href="#parsedinternalkey">ParsedInternalKey</a></li>
<li><a href="#lookupkey">LookupKey</a></li>

<li><p><a href="#memtable%E5%92%8C%E8%B7%B3%E8%B7%83%E8%A1%A8%E4%B8%AD%E5%AD%98%E5%82%A8%E7%9A%84key">memtable和跳跃表中存储的Key</a></p>

<h2 id="sequencenumber"><strong>SequenceNumber</strong></h2>

<p><code>SequenceNumber是一个无符号的64位整数类型，其高56位用来表示sequence，低8位用来表示ValueType</code></p></li>
</ul></li>

<li><p>将sequence和ValueType封装在一起</p></li>
</ul>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#00a8c8">static</span> <span style="color:#111">uint64_t</span> <span style="color:#75af00">PackSequenceAndType</span><span style="color:#111">(</span><span style="color:#111">uint64_t</span> <span style="color:#111">seq</span><span style="color:#111">,</span> <span style="color:#111">ValueType</span> <span style="color:#111">t</span><span style="color:#111">)</span> <span style="color:#111">{</span>
  <span style="color:#111">assert</span><span style="color:#111">(</span><span style="color:#111">seq</span> <span style="color:#f92672">&lt;=</span> <span style="color:#111">kMaxSequenceNumber</span><span style="color:#111">);</span>
  <span style="color:#111">assert</span><span style="color:#111">(</span><span style="color:#111">t</span> <span style="color:#f92672">&lt;=</span> <span style="color:#111">kValueTypeForSeek</span><span style="color:#111">);</span>
  <span style="color:#00a8c8">return</span> <span style="color:#111">(</span><span style="color:#111">seq</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">8</span><span style="color:#111">)</span> <span style="color:#f92672">|</span> <span style="color:#111">t</span><span style="color:#111">;</span>  <span style="color:#75715e">//seq左移8位，留下8位放type，总共64位
</span><span style="color:#75715e"></span><span style="color:#111">}</span>
<span style="color:#75715e">// We leave eight bits empty at the bottom so a type and sequence#
</span><span style="color:#75715e">// can be packed together into 64-bits.
</span><span style="color:#75715e">// sequence最大值，前56位全是1
</span><span style="color:#75715e"></span><span style="color:#00a8c8">static</span> <span style="color:#00a8c8">const</span> <span style="color:#111">SequenceNumber</span> <span style="color:#111">kMaxSequenceNumber</span> <span style="color:#f92672">=</span> <span style="color:#111">((</span><span style="color:#ae81ff">0x1ull</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">56</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">);</span>
</code></pre></div>
<h3 id="sequence">sequence</h3>

<p><code>sequence 为全局自增序列号，LevelDB 遇到一个修改操作，全局序列号自动加一。LevelDB 中的 Key 存储了多个版本的 Value。LevelDB 使用序列号来标记键值对的版本，序列号越大，对应的键值对越新。</code></p>

<h3 id="valuetype">ValueType</h3>

<p><code>ValueType用来表示该键的类型，是一个要被删除的键，还是一个插入或查询的键</code></p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#00a8c8">enum</span> <span style="color:#111">ValueType</span> <span style="color:#111">{</span>
  <span style="color:#111">kTypeDeletion</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span><span style="color:#111">,</span>
  <span style="color:#111">kTypeValue</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1</span>
<span style="color:#111">};</span>
<span style="color:#00a8c8">static</span> <span style="color:#00a8c8">const</span> <span style="color:#111">ValueType</span> <span style="color:#111">kValueTypeForSeek</span> <span style="color:#f92672">=</span> <span style="color:#111">kTypeValue</span><span style="color:#111">;</span>
</code></pre></div>
<h2 id="键"><strong>键</strong></h2>

<h3 id="user-key"><strong>user_key</strong></h3>

<p>user_key是levelDB用来表示用户插入或查询时使用的键值对中键的概念数据类型，对应于<code>DB::Put(key, value)</code>中的<code>key</code>,在levelDB中，用Slice数据类型来实际表示user_key</p>

<h3 id="internalkey">InternalKey</h3>

<p>InternalKey是memtable内部使用的键，InternalKey由三部分组成：
&gt;   <code>InteralKey = User_key + Sequence+ ValueType</code></p>

<h3 id="parsedinternalkey">ParsedInternalKey</h3>

<p>是InternalKey的辅助数据结构，用来帮助解析InternalKey，其声明如下：</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#00a8c8">struct</span> <span style="color:#111">ParsedInternalKey</span> <span style="color:#111">{</span>
  <span style="color:#111">Slice</span> <span style="color:#111">user_key</span><span style="color:#111">;</span>
  <span style="color:#111">SequenceNumber</span> <span style="color:#111">sequence</span><span style="color:#111">;</span>
  <span style="color:#111">ValueType</span> <span style="color:#111">type</span><span style="color:#111">;</span>

  <span style="color:#111">ParsedInternalKey</span><span style="color:#111">()</span> <span style="color:#111">{</span> <span style="color:#111">}</span>  <span style="color:#75715e">// Intentionally left uninitialized (for speed)
</span><span style="color:#75715e"></span>  <span style="color:#111">ParsedInternalKey</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Slice</span><span style="color:#f92672">&amp;</span> <span style="color:#111">u</span><span style="color:#111">,</span> <span style="color:#00a8c8">const</span> <span style="color:#111">SequenceNumber</span><span style="color:#f92672">&amp;</span> <span style="color:#111">seq</span><span style="color:#111">,</span> <span style="color:#111">ValueType</span> <span style="color:#111">t</span><span style="color:#111">)</span>
      <span style="color:#f92672">:</span> <span style="color:#111">user_key</span><span style="color:#111">(</span><span style="color:#111">u</span><span style="color:#111">),</span> <span style="color:#111">sequence</span><span style="color:#111">(</span><span style="color:#111">seq</span><span style="color:#111">),</span> <span style="color:#111">type</span><span style="color:#111">(</span><span style="color:#111">t</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#111">}</span>
  <span style="color:#111">std</span><span style="color:#f92672">::</span><span style="color:#111">string</span> <span style="color:#111">DebugString</span><span style="color:#111">()</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
<span style="color:#111">};</span>
</code></pre></div>
<h3 id="lookupkey">LookupKey</h3>

<p>同样是一个辅助</p>

<h3 id="memtable和跳跃表中存储的key">memtable和跳跃表中存储的Key</h3>

<blockquote>
<pre><code>leveldb中memtable实际上是对skipList的一个封装，也就是内存中，真正存储用户键值的数据结构是skipList。
skipList中Key是对用户键值的封装形成的:  
</code></pre>
</blockquote>

<pre><code>[ Key = internal_key_size + internal_key + value_size + value ]

其中：internal_key_size和value_size的数据类型都是VarInt
</code></pre>


    
    
        <div class="chevrons">
    <div id="navigation">
<a class="nav nav-prev" href="/levedb%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" title="LevelDB源码解析"> <i class="fa fa-chevron-left"></i><label>LevelDB源码解析</label></a>
    <a class="nav nav-next" href="/levedb%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/varint%E4%B8%8E%E7%BC%96%E7%A0%81/" title="VarInt与编码" style="margin-right: 0px;"><label>VarInt与编码</label><i class="fa fa-chevron-right"></i></a></div>
  </div>

  </section>
</article>

<footer>

<div class="footline">
    

    

    

    
    <div class="github-link">
      <a href="https://github.com/vjeantet/hugo-theme-docdock/edit/master/exampleSite/content/LeveDB%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90/levelDB%e5%90%84%e7%a7%8d%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b.md" target="blank"><i class="fa fa-code-fork"></i>
        Improve this page</a>
    </div>
    
  </div>


	<div>


  
    Create a content/_footer.md file to customize the footer content
  



	</div>
</footer>

<script src="/js/clipboard.min.js"></script>

<link href="/css/featherlight.min.css" rel="stylesheet">
<script src="/js/featherlight.min.js"></script>



<script src="/theme-flex/script.js"></script>


    

    
    

    
  </body>
</html>